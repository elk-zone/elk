<script setup lang="ts">
import type { mastodon } from 'masto'

const props = withDefaults(
  defineProps<{
    status: mastodon.v1.Status
    actions?: boolean
    context?: mastodon.v2.FilterContext
    hover?: boolean
    faded?: boolean

    // If we know the prev and next status in the timeline, we can simplify the card
    older?: mastodon.v1.Status
    newer?: mastodon.v1.Status
    // Manual overrides
    hasOlder?: boolean
    hasNewer?: boolean

    // When looking into a detailed view of a post, we can simplify the replying badges
    // to the main expanded post
    main?: mastodon.v1.Status
  }>(),
  { actions: true },
)

const userSettings = useUserSettings()

const status = $computed(() => {
  if (props.status.reblog && (!props.status.content || props.status.content === props.status.reblog.content))
    return props.status.reblog
  return props.status
})

// Use original status, avoid connecting a reblog
const directReply = $computed(() => props.hasNewer || (!!status.inReplyToId && (status.inReplyToId === props.newer?.id || status.inReplyToId === props.newer?.reblog?.id)))
// Use reblogged status, connect it to further replies
const connectReply = $computed(() => props.hasOlder || status.id === props.older?.inReplyToId || status.id === props.older?.reblog?.inReplyToId)
// Open a detailed status, the replies directly to it
const replyToMain = $computed(() => props.main && props.main.id === status.inReplyToId)

const rebloggedBy = $computed(() => props.status.reblog ? props.status.account : null)

const statusRoute = $computed(() => getStatusRoute(status))

const el = ref<HTMLElement>()
const router = useRouter()

function onclick(evt: MouseEvent | KeyboardEvent) {
  const path = evt.composedPath() as HTMLElement[]
  const el = path.find(el => ['A', 'BUTTON', 'IMG', 'VIDEO'].includes(el.tagName?.toUpperCase()))
  const text = window.getSelection()?.toString()
  if (!el && !text)
    go(evt)
}

function go(evt: MouseEvent | KeyboardEvent) {
  if (evt.metaKey || evt.ctrlKey) {
    window.open(statusRoute.href)
  }
  else {
    cacheStatus(status)
    router.push(statusRoute)
  }
}

const createdAt = useFormattedDateTime(status.createdAt)
const timeAgoOptions = useTimeAgoOptions(true)
const timeago = useTimeAgo(() => status.createdAt, timeAgoOptions)

const isSelfReply = $computed(() => status.inReplyToAccountId === status.account.id)
const collapseRebloggedBy = $computed(() => rebloggedBy?.id === status.account.id)
const isDM = $computed(() => status.visibility === 'direct')

const showUpperBorder = $computed(() => props.newer && !directReply)
const showReplyTo = $computed(() => !replyToMain && !directReply)

const shouldHideProfile = $computed(() => isSelfReply && getPreferences(userSettings.value, 'experimentalContinuousThreads'))
</script>

<template>
  <div
    :id="`status-${status.id}`" ref="el" p="is-3 ie-4" relative flex="~ col"
    :class="{ 'hover:bg-active': hover }" tabindex="0" focus:outline-none focus-visible:ring="2 primary"
    :lang="status.language ?? undefined" @click="onclick" @keydown.enter="onclick"
  >
    <!-- Upper border -->
    <div v-if="showUpperBorder" h-1px w-auto bg-border />

    <slot name="meta">
      <!-- Line connecting to previous status -->
      <template v-if="status.inReplyToAccountId">
        <StatusReplyingTo
          v-if="showReplyTo" m="is-5 t2" p="is-5" :status="status" :is-self-reply="isSelfReply"
          :class="faded ? 'text-secondary-light' : ''"
        />
        <div flex="~ col gap-1" items-center pos="absolute top-0 inset-is-0" w="77px" pr="0.5" z--1>
          <template v-if="showReplyTo">
            <div w="1px" h="0.5" border="x base" mt-3 />
            <div w="1px" h="0.5" border="x base" />
            <div w="1px" h="0.5" border="x base" />
            <div w="1px" h="10px" border="x base" />
          </template>
          <div v-else w="1px" h="10px" border="x base" />
        </div>
      </template>

      <!-- Reblog status -->
      <div v-if="rebloggedBy && !collapseRebloggedBy" mt2 flex="~ col" justify-between>
        <div flex="~" items-center p="t-1 b-0.5 x-1px" relative text-secondary ws-nowrap>
          <div i-ri:repeat-fill me-46px text-green w-16px h-16px class="status-boosted" />
          <div absolute top-1 ms-24px w-32px h-32px rounded-full>
            <AccountHoverWrapper :account="rebloggedBy">
              <NuxtLink :to="getAccountRoute(rebloggedBy)">
                <AccountAvatar :account="rebloggedBy" />
              </NuxtLink>
            </AccountHoverWrapper>
          </div>
          <AccountInlineInfo font-bold :account="rebloggedBy" :avatar="false" text-sm />
        </div>
      </div>
    </slot>

    <div flex mt2 gap-3 :class="{ 'text-secondary': faded }">
      <!-- Avatar -->
      <div flex="~ col" items-center w-54px relative>
        <div
          v-if="collapseRebloggedBy" absolute flex items-center justify-center top--6px px-2px py-3px rounded-full
          bg-base
        >
          <div i-ri:repeat-fill text-green w-16px h-16px />
        </div>
        <AccountHoverWrapper v-if="!shouldHideProfile" :account="status.account">
          <NuxtLink :to="getAccountRoute(status.account)" rounded-full>
            <AccountBigAvatar :account="status.account" />
          </NuxtLink>
        </AccountHoverWrapper>

        <!-- the mb15px is the 33px the icon container takes, minus the 18px of the icon -->
        <div v-if="connectReply || shouldHideProfile" w-1px grow border="x base" :class="`${(!connectReply && shouldHideProfile) ? 'mb15px' : ''}`" />
      </div>

      <!-- Main -->
      <div flex="~ col 1 gap2" min-w-0>
        <!-- Account Info -->
        <div v-if="!shouldHideProfile" flex items-center space-x-1>
          <AccountHoverWrapper :account="status.account">
            <StatusAccountDetails :account="status.account" />
          </AccountHoverWrapper>
          <div flex-auto />
          <div
            v-show="!userSettings.zenMode" text-sm text-secondary flex="~ row nowrap" hover:underline
            whitespace-nowrap
          >
            <AccountBotIndicator v-if="status.account.bot" me-2 />
            <div flex="~ gap1" items-center>
              <StatusVisibilityIndicator v-if="status.visibility !== 'public'" :status="status" />
              <div flex>
                <CommonTooltip :content="createdAt">
                  <NuxtLink :title="status.createdAt" :href="statusRoute.href" @click.prevent="go($event)">
                    <time text-sm ws-nowrap hover:underline :datetime="status.createdAt">
                      {{ timeago }}
                    </time>
                  </NuxtLink>
                </CommonTooltip>
                <StatusEditIndicator :status="status" inline />
              </div>
            </div>
          </div>
          <StatusActionsMore v-if="actions !== false" :status="status" me--2 />
        </div>

        <!-- Content -->
        <StatusContent :status="status" :newer="newer" :context="context" :class="{ 'mt-2 mb1': isDM }" />
        <StatusActions v-if="actions !== false" v-show="!userSettings.zenMode" :status="status" mb2 />
      </div>
    </div>
  </div>
</template>
